---
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import CookieBanner from '@/components/CookieBanner.astro';
import '@/styles/global.css';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
}

const {
  title,
  description = 'Create beautiful topographical trail maps for Instagram Stories and Posts. Share your hiking adventures with stunning visuals.',
  ogImage: customOgImage
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImage = new URL(customOgImage || '/images/og-image.jpg', Astro.site);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | TopoStory</title>

    <!-- Open Graph -->
    <meta property="og:title" content={`${title} | TopoStory`} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="TopoStory" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content="en_IE" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${title} | TopoStory`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "TopoStory",
      "url": "https://www.topostory.com",
      "description": "Create beautiful topographical trail maps for Instagram Stories and Posts. Share your hiking adventures with stunning visuals."
    })} />

    <!-- Page-specific head content -->
    <slot name="head" />

    <!-- PostHog Analytics + Intercom Support (consent-aware) -->
    <script is:inline define:vars={{
      posthogKey: import.meta.env.PUBLIC_POSTHOG_KEY,
      intercomAppId: import.meta.env.PUBLIC_INTERCOM_APP_ID
    }}>
      // Check consent before initializing analytics
      function getConsentFromCookie() {
        const match = document.cookie.match(/topostory_consent=([^;]+)/);
        if (!match) return null;
        try {
          return JSON.parse(decodeURIComponent(match[1]));
        } catch {
          return null;
        }
      }

      // Capture UTM parameters immediately (before consent)
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const utmParams = {};
        ['source', 'medium', 'campaign', 'term', 'content'].forEach(function(param) {
          const value = urlParams.get('utm_' + param);
          if (value) utmParams['utm_' + param] = value;
        });
        if (Object.keys(utmParams).length > 0) {
          sessionStorage.setItem('topostory_utm', JSON.stringify(utmParams));
        }
      } catch (e) {
        // Silently fail if sessionStorage is not available
      }

      let posthogInitialized = false;
      let intercomInitialized = false;

      function initPostHog() {
        if (posthogInitialized || !posthogKey) return;
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init(posthogKey, {
          api_host: '/t',
          capture_pageview: true,
          capture_pageleave: true,
          cookie_domain: '.topostory.com',
          cross_subdomain_cookie: true
        });

        // Register UTM parameters as super properties (first-touch attribution)
        try {
          const storedUTM = sessionStorage.getItem('topostory_utm');
          if (storedUTM) {
            const params = JSON.parse(storedUTM);
            const superProps = {};
            Object.keys(params).forEach(function(key) {
              superProps['initial_' + key] = params[key];
            });
            posthog.register_once(superProps);
          }
        } catch (e) {
          // Silently fail if sessionStorage is not available
        }

        posthogInitialized = true;
      }

      function initIntercom() {
        if (intercomInitialized || !intercomAppId) return;
        window.intercomSettings = { api_base: "https://api-iam.intercom.io", app_id: intercomAppId };
        (function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/' + intercomAppId;var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(document.readyState==='complete'){l();}else if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
        intercomInitialized = true;
      }

      // Initialize based on existing consent
      const consent = getConsentFromCookie();
      if (consent?.categories?.analytics) {
        initPostHog();
      }
      if (consent?.categories?.marketing) {
        initIntercom();
      }

      // Listen for consent changes from the cookie banner
      window.addEventListener('consent-analytics-allowed', initPostHog);
      window.addEventListener('consent-marketing-allowed', initIntercom);
    </script>

    <!-- Loading States for External CTAs -->
    <script is:inline>
      document.addEventListener('DOMContentLoaded', function() {
        // Add loading state to external CTA buttons
        document.querySelectorAll('a[href*="app.topostory.com"]').forEach(function(link) {
          link.addEventListener('click', function(e) {
            // Add loading class
            this.classList.add('opacity-75', 'pointer-events-none');
            // Add a subtle loading indicator
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="inline-flex items-center gap-2">' +
              '<svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">' +
              '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>' +
              '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>' +
              '</svg>' + originalText + '</span>';
            // Restore after navigation (in case user navigates back)
            setTimeout(function() {
              link.innerHTML = originalText;
              link.classList.remove('opacity-75', 'pointer-events-none');
            }, 3000);
          });
        });
      });
    </script>

    <!-- PostHog Custom Event Tracking -->
    <script is:inline>
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof posthog === 'undefined' || !posthog.capture) return;

        // Track CTA clicks (links to app.topostory.com)
        document.querySelectorAll('a[href*="app.topostory.com"]').forEach(function(el) {
          el.addEventListener('click', function() {
            // Append UTM parameters to destination URL
            try {
              const storedUTM = sessionStorage.getItem('topostory_utm');
              if (storedUTM) {
                const params = JSON.parse(storedUTM);
                const url = new URL(this.href);
                Object.keys(params).forEach(function(key) {
                  if (!url.searchParams.has(key)) {
                    url.searchParams.set(key, params[key]);
                  }
                });
                this.href = url.toString();
              }
            } catch (e) {
              // Continue with original href if URL modification fails
            }

            posthog.capture('cta_clicked', {
              cta_text: this.textContent.trim(),
              cta_location: this.closest('section')?.id || this.closest('header') ? 'header' : 'page',
              destination_url: this.href,
              page: window.location.pathname
            });
          });
        });

        // Track style preview card clicks
        document.querySelectorAll('[data-style-preview]').forEach(function(el) {
          el.addEventListener('click', function() {
            posthog.capture('style_preview_clicked', {
              style_name: this.dataset.stylePreview,
              page: window.location.pathname
            });
          });
        });

        // Track pricing section visibility
        var pricingSection = document.querySelector('[data-pricing-section]');
        if (pricingSection && 'IntersectionObserver' in window) {
          var observed = false;
          var observer = new IntersectionObserver(function(entries) {
            if (entries[0].isIntersecting && !observed) {
              observed = true;
              posthog.capture('pricing_plan_viewed', {
                page: window.location.pathname
              });
              observer.disconnect();
            }
          }, { threshold: 0.5 });
          observer.observe(pricingSection);
        }
      });
    </script>
  </head>
  <body class="min-h-screen flex flex-col">
    <Header />
    <main class="flex-1 pt-16">
      <slot />
    </main>
    <Footer />
    <CookieBanner />
  </body>
</html>
