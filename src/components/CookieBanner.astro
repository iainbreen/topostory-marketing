---
// Cookie Consent Banner - uses client-side JS for interactivity
---

<div id="cookie-banner" class="fixed bottom-0 left-0 right-0 z-50 bg-white border-t border-terrain-100 shadow-lg hidden">
  <div class="max-w-6xl mx-auto px-4 py-4 sm:px-6 sm:py-5">
    <div class="flex flex-col sm:flex-row sm:items-center gap-4">
      <!-- Message -->
      <div class="flex-1">
        <p class="text-terrain-700 text-sm sm:text-base">
          We use cookies to enhance your experience and analyze site usage.
          <a href="/privacy" class="text-forest-600 underline hover:text-forest-500">Learn more</a>
        </p>
      </div>

      <!-- Actions -->
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <button
          id="cookie-customize"
          class="text-sm text-terrain-600 hover:text-forest-600 underline"
        >
          Customize
        </button>
        <button
          id="cookie-reject"
          class="px-4 py-2 text-sm font-medium text-terrain-700 bg-terrain-100 hover:bg-terrain-200 rounded transition-colors"
        >
          Reject All
        </button>
        <button
          id="cookie-accept"
          class="px-4 py-2 text-sm font-medium text-white bg-forest-600 hover:bg-forest-500 rounded transition-colors"
        >
          Accept All
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Preferences Modal -->
<div id="cookie-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div id="cookie-modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

  <!-- Modal -->
  <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
    <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto pointer-events-auto">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-terrain-100">
        <h2 class="text-lg font-serif font-semibold text-terrain-900">
          Cookie Preferences
        </h2>
        <p class="text-sm text-terrain-600 mt-1">
          Choose which cookies you allow. You can change these settings at any time.
        </p>
      </div>

      <!-- Categories -->
      <div class="px-6 py-4 space-y-4">
        <!-- Necessary - Always on -->
        <div class="flex items-start gap-4 p-3 bg-terrain-50 rounded-lg">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="font-medium text-terrain-900">Necessary</span>
              <span class="text-xs text-terrain-500 bg-terrain-200 px-2 py-0.5 rounded">Always on</span>
            </div>
            <p class="text-sm text-terrain-600 mt-1">
              Essential cookies for core functionality.
            </p>
          </div>
          <div class="pt-1">
            <div class="w-10 h-6 bg-forest-600 rounded-full relative cursor-not-allowed opacity-60">
              <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
            </div>
          </div>
        </div>

        <!-- Analytics -->
        <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-terrain-50">
          <div class="flex-1">
            <span class="font-medium text-terrain-900">Analytics</span>
            <p class="text-sm text-terrain-600 mt-1">
              Usage analytics and session recording to help us improve the product.
            </p>
          </div>
          <div class="pt-1">
            <button
              id="toggle-analytics"
              class="w-10 h-6 bg-terrain-300 rounded-full relative transition-colors"
              role="switch"
              aria-checked="false"
              aria-label="Toggle Analytics"
              data-enabled="false"
            >
              <div class="toggle-knob absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
            </button>
          </div>
        </div>

        <!-- Marketing -->
        <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-terrain-50">
          <div class="flex-1">
            <span class="font-medium text-terrain-900">Support & Marketing</span>
            <p class="text-sm text-terrain-600 mt-1">
              Support chat and tools to help us communicate with you.
            </p>
          </div>
          <div class="pt-1">
            <button
              id="toggle-marketing"
              class="w-10 h-6 bg-terrain-300 rounded-full relative transition-colors"
              role="switch"
              aria-checked="false"
              aria-label="Toggle Marketing"
              data-enabled="false"
            >
              <div class="toggle-knob absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
            </button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-terrain-100 flex justify-end gap-3">
        <button
          id="cookie-modal-cancel"
          class="px-4 py-2 text-sm font-medium text-terrain-700 hover:text-terrain-900 transition-colors"
        >
          Cancel
        </button>
        <button
          id="cookie-modal-save"
          class="px-4 py-2 text-sm font-medium text-white bg-forest-600 hover:bg-forest-500 rounded transition-colors"
        >
          Save Preferences
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Cookie consent logic
  const COOKIE_NAME = 'topostory_consent';
  const COOKIE_DOMAIN = '.topostory.com';
  const COOKIE_MAX_AGE_DAYS = 365;

  interface ConsentCategories {
    necessary: true;
    analytics: boolean;
    marketing: boolean;
  }

  interface ConsentState {
    version: number;
    timestamp: string;
    categories: ConsentCategories;
  }

  function getConsent(): ConsentState | null {
    const match = document.cookie.match(new RegExp(`${COOKIE_NAME}=([^;]+)`));
    if (!match) return null;

    try {
      const decoded = decodeURIComponent(match[1]);
      const parsed = JSON.parse(decoded) as ConsentState;
      if (
        typeof parsed.version !== 'number' ||
        typeof parsed.categories?.analytics !== 'boolean' ||
        typeof parsed.categories?.marketing !== 'boolean'
      ) {
        return null;
      }
      return parsed;
    } catch {
      return null;
    }
  }

  function setConsent(categories: Omit<ConsentCategories, 'necessary'>): void {
    const state: ConsentState = {
      version: 1,
      timestamp: new Date().toISOString(),
      categories: {
        necessary: true,
        analytics: categories.analytics,
        marketing: categories.marketing,
      },
    };

    const value = encodeURIComponent(JSON.stringify(state));
    const maxAge = COOKIE_MAX_AGE_DAYS * 24 * 60 * 60;
    const isLocalhost = window.location.hostname === 'localhost';
    const domainPart = isLocalhost ? '' : `; domain=${COOKIE_DOMAIN}`;

    document.cookie = `${COOKIE_NAME}=${value}${domainPart}; path=/; max-age=${maxAge}; SameSite=Lax; Secure`;
  }

  function hasConsented(): boolean {
    return getConsent() !== null;
  }

  // Elements
  const banner = document.getElementById('cookie-banner');
  const modal = document.getElementById('cookie-modal');
  const modalBackdrop = document.getElementById('cookie-modal-backdrop');
  const acceptBtn = document.getElementById('cookie-accept');
  const rejectBtn = document.getElementById('cookie-reject');
  const customizeBtn = document.getElementById('cookie-customize');
  const cancelBtn = document.getElementById('cookie-modal-cancel');
  const saveBtn = document.getElementById('cookie-modal-save');
  const toggleAnalytics = document.getElementById('toggle-analytics') as HTMLButtonElement;
  const toggleMarketing = document.getElementById('toggle-marketing') as HTMLButtonElement;

  // State
  let analyticsEnabled = false;
  let marketingEnabled = false;

  function updateToggleUI(button: HTMLButtonElement, enabled: boolean) {
    button.dataset.enabled = String(enabled);
    button.setAttribute('aria-checked', String(enabled));
    if (enabled) {
      button.classList.remove('bg-terrain-300');
      button.classList.add('bg-forest-600');
      button.querySelector('.toggle-knob')?.classList.remove('left-1');
      button.querySelector('.toggle-knob')?.classList.add('right-1');
    } else {
      button.classList.remove('bg-forest-600');
      button.classList.add('bg-terrain-300');
      button.querySelector('.toggle-knob')?.classList.remove('right-1');
      button.querySelector('.toggle-knob')?.classList.add('left-1');
    }
  }

  function showBanner() {
    banner?.classList.remove('hidden');
  }

  function hideBanner() {
    banner?.classList.add('hidden');
  }

  function showModal() {
    // Load existing preferences
    const consent = getConsent();
    analyticsEnabled = consent?.categories.analytics ?? false;
    marketingEnabled = consent?.categories.marketing ?? false;
    updateToggleUI(toggleAnalytics, analyticsEnabled);
    updateToggleUI(toggleMarketing, marketingEnabled);

    hideBanner();
    modal?.classList.remove('hidden');
  }

  function hideModal() {
    modal?.classList.add('hidden');
  }

  function initAnalyticsIfAllowed() {
    const consent = getConsent();
    if (consent?.categories.analytics) {
      // Trigger custom event that BaseLayout listens for
      window.dispatchEvent(new CustomEvent('consent-analytics-allowed'));
    }
    if (consent?.categories.marketing) {
      window.dispatchEvent(new CustomEvent('consent-marketing-allowed'));
    }
  }

  // Event handlers
  acceptBtn?.addEventListener('click', () => {
    setConsent({ analytics: true, marketing: true });
    hideBanner();
    initAnalyticsIfAllowed();
  });

  rejectBtn?.addEventListener('click', () => {
    setConsent({ analytics: false, marketing: false });
    hideBanner();
  });

  customizeBtn?.addEventListener('click', () => {
    showModal();
  });

  cancelBtn?.addEventListener('click', () => {
    hideModal();
    if (!hasConsented()) {
      showBanner();
    }
  });

  modalBackdrop?.addEventListener('click', () => {
    hideModal();
    if (!hasConsented()) {
      showBanner();
    }
  });

  saveBtn?.addEventListener('click', () => {
    setConsent({ analytics: analyticsEnabled, marketing: marketingEnabled });
    hideModal();
    initAnalyticsIfAllowed();
  });

  toggleAnalytics?.addEventListener('click', () => {
    analyticsEnabled = !analyticsEnabled;
    updateToggleUI(toggleAnalytics, analyticsEnabled);
  });

  toggleMarketing?.addEventListener('click', () => {
    marketingEnabled = !marketingEnabled;
    updateToggleUI(toggleMarketing, marketingEnabled);
  });

  // Footer cookie settings button handler
  document.getElementById('cookie-settings-trigger')?.addEventListener('click', () => {
    showModal();
  });

  // Initialize on page load
  if (!hasConsented()) {
    showBanner();
  }
</script>
